# ZEGO UIKit 多房间支持技术方案

## 📋 文档信息

- **版本**: v1.0
- **日期**: 2025-11-11
- **改动范围**: `zego_uikit/lib/src/services`
- **代码变更**: +1,730 行 (14,639 → 16,369 行，增长 11.8%)

---

## 🎯 方案概述

本次改动为 ZEGO UIKit 增加了**多房间支持能力**，允许用户同时加入和管理多个音视频房间。核心设计理念是：

- ✅ **向后兼容**: 保持原有单房间 API 不变，默认行为与之前一致
- ✅ **可选升级**: 通过 `targetRoomID` 参数支持多房间场景
- ✅ **数据隔离**: 每个房间的用户、流、消息等数据完全隔离
- ✅ **灵活切换**: 支持单房间模式和多房间模式的运行时配置

---

## 🏗️ 架构设计

### 1. 整体架构变化

#### 1.1 目录结构重组

```
services/
├── core/                    # 核心层 (原 internal/)
│   ├── data/               # 数据层
│   │   ├── room.dart       # 多房间管理器
│   │   ├── room_map.dart   # 房间映射容器
│   │   ├── room.single.dart # 单房间数据
│   │   ├── user.dart       # 用户管理器
│   │   ├── user.room.dart  # 房间级用户数据
│   │   ├── stream.dart     # 流管理器
│   │   ├── stream.room.dart # 房间级流数据
│   │   ├── message.room.dart # 房间级消息数据
│   │   ├── engine.dart     # 引擎状态
│   │   └── error.dart      # 错误管理
│   ├── defines/            # 核心定义
│   └── event/              # 事件处理
├── defines/                # 公共定义层
│   ├── room/               # 房间相关定义 (原 room.dart)
│   ├── user/               # 用户相关定义 (原 user.dart)
│   ├── audio_video/        # 音视频定义 (原 audio_video.dart)
│   └── ...
└── *_service.dart          # 服务层 (16 个文件修改)
```

**关键变化**:
- `internal/` → `core/`: 提升核心代码层级，更清晰的模块划分
- 单文件拆分为目录: 便于扩展和维护
- 新增房间级数据文件: 实现数据隔离

#### 1.2 层次架构

```
┌─────────────────────────────────────────────────────────┐
│              Service Layer (服务层)                      │
│  room_service, user_service, audio_video_service...     │
│  - 提供统一的 API 接口                                    │
│  - 处理 targetRoomID 参数                                │
│  - 向后兼容的默认行为                                     │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│              Core Layer (核心层)                         │
│  ZegoUIKitCore.shared.coreData                          │
│  - 管理多房间数据结构                                     │
│  - 协调房间间的资源                                       │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│              Data Layer (数据层)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ Room Manager │  │ User Manager │  │Stream Manager│  │
│  │   (room)     │  │   (user)     │  │  (stream)    │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                  │                  │          │
│  ┌──────▼──────────────────▼──────────────────▼───────┐ │
│  │         RoomMap<T> (房间映射容器)                   │ │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐            │ │
│  │  │ Room A  │  │ Room B  │  │ Room C  │  ...       │ │
│  │  │ Data    │  │ Data    │  │ Data    │            │ │
│  │  └─────────┘  └─────────┘  └─────────┘            │ │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

---

### 2. 核心数据结构

#### 2.1 多房间数据存储架构

```
ZegoUIKitCoreData
├── room: ZegoUIKitCoreDataRoom
│   ├── mode: ZegoUIKitRoomMode (SingleRoom/MultiRoom)
│   ├── currentID: String (当前房间 ID)
│   ├── currentIDQueryOfMultiRoom: Callback (多房间模式下的当前房间查询)
│   └── rooms: RoomMap<ZegoUIKitCoreDataSingleRoom>
│       ├── "room_001": ZegoUIKitCoreDataSingleRoom
│       │   ├── id: "room_001"
│       │   ├── state: ValueNotifier<ZegoUIKitRoomState>
│       │   ├── properties: Map<String, RoomProperty>
│       │   ├── isLogin: bool
│       │   └── ...
│       ├── "room_002": ZegoUIKitCoreDataSingleRoom
│       └── "room_003": ZegoUIKitCoreDataSingleRoom
│
├── user: ZegoUIKitCoreDataUser
│   ├── localUser: ZegoUIKitCoreUser (全局本地用户)
│   └── roomUsers: RoomMap<ZegoUIKitCoreDataRoomUser>
│       ├── "room_001": ZegoUIKitCoreDataRoomUser
│       │   ├── roomID: "room_001"
│       │   ├── remoteUsers: List<ZegoUIKitCoreUser>
│       │   ├── joinStreamCtrl: StreamController
│       │   ├── leaveStreamCtrl: StreamController
│       │   └── listStreamCtrl: StreamController
│       ├── "room_002": ZegoUIKitCoreDataRoomUser
│       └── "room_003": ZegoUIKitCoreDataRoomUser
│
├── stream: ZegoUIKitCoreDataStream
│   └── roomStreams: RoomMap<ZegoUIKitCoreDataRoomStream>
│       ├── "room_001": ZegoUIKitCoreDataRoomStream
│       │   ├── roomID: "room_001"
│       │   ├── playingStreamIDs: List<String>
│       │   ├── streamDic: Map<String, ZegoUIKitCoreStream>
│       │   └── ...
│       ├── "room_002": ZegoUIKitCoreDataRoomStream
│       └── "room_003": ZegoUIKitCoreDataRoomStream
│
├── message: ZegoUIKitCoreDataMessage
│   └── roomMessages: RoomMap<ZegoUIKitCoreDataRoomMessage>
│       ├── "room_001": ZegoUIKitCoreDataRoomMessage
│       ├── "room_002": ZegoUIKitCoreDataRoomMessage
│       └── "room_003": ZegoUIKitCoreDataRoomMessage
│
├── engine: ZegoUIKitCoreDataEngine (全局引擎状态)
├── device: ZegoUIKitCoreDataDevice (全局设备状态)
├── error: ZegoUIKitCoreDataError (全局错误管理)
└── media: ZegoUIKitCoreDataMedia (全局媒体状态)
```

#### 2.2 RoomMap 容器设计

`RoomMap<T>` 是多房间架构的核心容器，提供：

**核心特性**:
- 🔒 **线程安全**: 使用 `Lock` 保护并发访问
- 🎯 **预备房间机制**: 支持空 roomID 的预创建，避免监听器丢失
- ♻️ **房间升级**: 预备房间可升级为真实房间，保持状态连续性
- 🔄 **同步/异步遍历**: 支持 `forEachSync` 和 `forEachAsync`

**关键方法**:
```
RoomMap<T>
├── getRoom(roomID): T              # 获取或创建房间数据
├── putRoom(roomID, value)          # 添加/更新房间
├── removeRoom(roomID)              # 删除房间
├── clearRooms()                    # 清空所有房间
├── forEachSync(action)             # 同步遍历
├── forEachAsync(action)            # 异步遍历
├── containsRoom(roomID): bool      # 检查房间是否存在
├── allRoomIDs: List<String>        # 获取所有房间 ID
└── roomCount: int                  # 房间数量
```

---

### 3. 房间模式设计

#### 3.1 运行模式

```dart
enum ZegoUIKitRoomMode {
  SingleRoom,  // 单房间模式 (默认)
  MultiRoom    // 多房间模式
}
```

#### 3.2 模式对比

| 特性 | 单房间模式 | 多房间模式 |
|------|-----------|-----------|
| **房间数量** | 最多 1 个 | 支持多个 |
| **currentID 获取** | 自动 (loginRoomIDs.first) | 需要回调函数 |
| **房间切换** | 自动退出旧房间 | 手动管理 |
| **API 使用** | 无需 targetRoomID | 需要 targetRoomID |
| **向后兼容** | ✅ 完全兼容 | ⚠️ 需要适配 |

#### 3.3 当前房间 ID 获取逻辑

```
currentID 获取流程:
┌─────────────────────────────────────┐
│ 获取 currentID                       │
└────────────┬────────────────────────┘
             │
    ┌────────▼────────┐
    │ 检查 mode       │
    └────────┬────────┘
             │
      ┌──────┴──────┐
      │             │
┌─────▼─────┐ ┌────▼──────────────────┐
│SingleRoom │ │ MultiRoom             │
└─────┬─────┘ └────┬──────────────────┘
      │            │
      │            │ 调用 currentIDQueryOfMultiRoom
      │            │ (外部提供的回调函数)
      │            │
┌─────▼────────────▼─────┐
│ 返回 loginRoomIDs.first│
│ 或回调函数返回值        │
└────────────────────────┘
```

**设计理由**:
- 单房间模式: 只有一个房间，currentID 确定
- 多房间模式: 多个房间并存，"当前"概念由业务层定义

---

### 4. API 兼容性设计

#### 4.1 参数扩展模式

所有房间相关 API 采用统一的扩展模式:

```dart
// 原 API (保持不变)
Future<void> someMethod(String param);

// 新 API (向后兼容)
Future<void> someMethod(
  String param, {
  String? targetRoomID,  // 可选参数
});

// 内部实现
final roomID = targetRoomID ?? ZegoUIKitCore.shared.coreData.room.currentID;
```

#### 4.2 受影响的服务层

| 服务 | 主要变化 | 新增参数方法数 |
|------|---------|--------------|
| **RoomService** | 房间属性、状态、Token 管理 | 8 个 |
| **UserService** | 用户列表、属性、事件流 | 9 个 |
| **AudioVideoService** | 音视频播放、静音控制 | 7 个 |
| **MessageService** | 房间消息发送接收 | 5 个 |
| **DeviceService** | 设备状态管理 | 3 个 |
| **MediaService** | 媒体播放控制 | 4 个 |

**总计**: 16 个服务文件修改，约 40+ 个方法增加 `targetRoomID` 参数

#### 4.3 兼容性保证

✅ **默认行为不变**:
```dart
// 单房间模式下，以下两种调用完全等价
ZegoUIKit().getRoom();
ZegoUIKit().getRoom(targetRoomID: currentRoomID);
```

✅ **渐进式升级**:
```dart
// 步骤 1: 初始化时指定多房间模式
ZegoUIKit().init(
  roomMode: ZegoUIKitRoomMode.MultiRoom,
  // ...
);

// 步骤 2: 设置当前房间查询回调
ZegoUIKitCore.shared.coreData.room.currentIDQueryOfMultiRoom = 
  (loginRoomIDs) => myCurrentRoomID;

// 步骤 3: 使用 targetRoomID 参数
ZegoUIKit().getRoom(targetRoomID: "room_001");
ZegoUIKit().getRoom(targetRoomID: "room_002");
```

---

## 🔄 数据流转

### 1. 房间加入流程

```
用户调用 joinRoom(roomID)
         │
         ▼
┌────────────────────────┐
│ 检查房间数量限制        │
└────────┬───────────────┘
         │
    ┌────▼────┐
    │ 单房间? │
    └────┬────┘
         │
    ┌────┴────┐
    │ Yes     │ No
    ▼         ▼
┌───────┐  ┌──────────┐
│退出旧房│  │允许多房间│
└───┬───┘  └────┬─────┘
    │           │
    └─────┬─────┘
          ▼
┌─────────────────────┐
│ rooms.getRoom(roomID)│ ← 获取或创建房间数据
└─────────┬───────────┘
          ▼
┌─────────────────────┐
│ 调用 Express SDK    │
│ loginRoom()         │
└─────────┬───────────┘
          ▼
┌─────────────────────┐
│ 更新房间状态        │
│ room.isLogin = true │
└─────────┬───────────┘
          ▼
┌─────────────────────┐
│ 标记缓存为脏        │
│ _markLoginRoomIDs   │
│ CacheDirty()        │
└─────────────────────┘
```

### 2. 数据访问流程

```
Service Layer API 调用
         │
         ▼
┌────────────────────────┐
│ 解析 targetRoomID      │
│ roomID = targetRoomID  │
│   ?? currentID         │
└────────┬───────────────┘
         ▼
┌────────────────────────┐
│ 访问房间数据            │
│ rooms.getRoom(roomID)  │
└────────┬───────────────┘
         ▼
┌────────────────────────┐
│ RoomMap 查找/创建      │
└────────┬───────────────┘
         ▼
    ┌────┴────┐
    │ 存在?   │
    └────┬────┘
         │
    ┌────┴────┐
    │ Yes     │ No
    ▼         ▼
┌───────┐  ┌──────────────┐
│返回实例│  │创建新实例     │
└───────┘  │(或升级预备房间)│
           └──────┬───────┘
                  ▼
           ┌──────────────┐
           │ 返回新实例    │
           └──────────────┘
```

---

## 📊 关键优化

### 1. 性能优化

#### 1.1 登录房间列表缓存

```dart
// 问题: 频繁遍历所有房间检查登录状态
List<String> get loginRoomIDs {
  rooms.forEachSync((roomID, room) {
    if (room.isLogin) roomIDs.add(roomID);
  });
}

// 优化: 缓存 + 脏标记
List<String> _cachedLoginRoomIDs = [];
bool _loginRoomIDsCacheDirty = true;

List<String> get loginRoomIDs {
  if (!_loginRoomIDsCacheDirty) {
    return List.from(_cachedLoginRoomIDs);
  }
  // 重新计算并缓存
  _cachedLoginRoomIDs = calculateLoginRoomIDs();
  _loginRoomIDsCacheDirty = false;
  return List.from(_cachedLoginRoomIDs);
}
```

#### 1.2 预备房间机制

避免在获取房间数据前需要先设置监听器的问题:

```
场景: UI 组件需要监听房间状态
┌──────────────────────────────────────┐
│ 1. 获取房间对象 (roomID 可能为空)     │
│    room = getRoom("")                │
│    返回预备房间 (_emptyRoomCache)    │
└────────────┬─────────────────────────┘
             ▼
┌──────────────────────────────────────┐
│ 2. 设置监听器                         │
│    room.state.addListener(...)       │
└────────────┬─────────────────────────┘
             ▼
┌──────────────────────────────────────┐
│ 3. 加入真实房间                       │
│    joinRoom("room_001")              │
│    预备房间升级为真实房间             │
│    监听器保持有效 ✅                  │
└──────────────────────────────────────┘
```

---

## 🎨 设计亮点

### 1. 数据隔离与共享

```
全局共享数据:
├── engine (引擎状态)
├── device (设备状态)
├── error (错误管理)
└── localUser (本地用户信息)

房间隔离数据:
├── room (房间属性、状态)
├── user.roomUsers (房间内的远程用户)
├── stream.roomStreams (房间内的音视频流)
└── message.roomMessages (房间内的消息)
```

**设计理由**:
- 引擎、设备是全局资源，所有房间共享
- 用户、流、消息是房间级资源，需要隔离

### 2. 向后兼容的渐进式设计

```
兼容性层次:
Level 1: 完全兼容 (无需修改代码)
  └─ 单房间模式 + 不传 targetRoomID

Level 2: 配置升级 (修改初始化)
  └─ 多房间模式 + 设置 currentIDQuery

Level 3: API 升级 (使用新参数)
  └─ 多房间模式 + 传递 targetRoomID
```

### 3. 类型安全的泛型容器

```dart
RoomMap<ZegoUIKitCoreDataSingleRoom>  // 房间数据
RoomMap<ZegoUIKitCoreDataRoomUser>    // 用户数据
RoomMap<ZegoUIKitCoreDataRoomStream>  // 流数据
RoomMap<ZegoUIKitCoreDataRoomMessage> // 消息数据
```

统一的容器接口，不同的数据类型，保证类型安全。

---

## 📝 使用示例

### 单房间模式 (默认，无需修改)

```dart
// 初始化 (默认单房间模式)
await ZegoUIKit().init(appID: xxx, appSign: xxx);

// 加入房间
await ZegoUIKit().joinRoom(roomID: "room_001");

// 使用 API (无需 targetRoomID)
final room = ZegoUIKit().getRoom();
final users = ZegoUIKit().getAllUsers();
```

### 多房间模式

```dart
// 初始化 (指定多房间模式)
await ZegoUIKit().init(
  appID: xxx,
  appSign: xxx,
  roomMode: ZegoUIKitRoomMode.MultiRoom,
);

// 设置当前房间查询回调
ZegoUIKitCore.shared.coreData.room.currentIDQueryOfMultiRoom = 
  (loginRoomIDs) => _myCurrentRoomID;

// 加入多个房间
await ZegoUIKit().joinRoom(roomID: "room_001");
await ZegoUIKit().joinRoom(roomID: "room_002");

// 使用 API (指定 targetRoomID)
final room1 = ZegoUIKit().getRoom(targetRoomID: "room_001");
final room2 = ZegoUIKit().getRoom(targetRoomID: "room_002");
final users1 = ZegoUIKit().getAllUsers(targetRoomID: "room_001");
final users2 = ZegoUIKit().getAllUsers(targetRoomID: "room_002");
```

---

## 🔍 技术要点总结

### 核心设计原则

1. **向后兼容优先**: 默认行为与原版本完全一致
2. **数据隔离清晰**: 房间级数据完全隔离，全局数据共享
3. **API 设计一致**: 统一的 `targetRoomID` 参数模式
4. **性能优化**: 缓存机制、预备房间机制
5. **类型安全**: 泛型容器、强类型定义

### 关键技术点

- ✅ `RoomMap<T>` 泛型容器实现多房间数据管理
- ✅ 预备房间机制解决监听器生命周期问题
- ✅ 缓存 + 脏标记优化频繁查询
- ✅ 线程安全的异步遍历
- ✅ 单房间/多房间模式运行时切换
- ✅ 灵活的当前房间 ID 查询机制

---

## 📈 改动统计

| 类别 | 数量 | 说明 |
|------|------|------|
| **新增文件** | 9 个 | room_map.dart, room.single.dart, user.room.dart 等 |
| **修改文件** | 16 个 | 所有 service 层文件 |
| **新增目录** | 5 个 | core/, utils/, log_exporter/, room/, user/ 等 |
| **代码行数** | +1,730 行 | 14,639 → 16,369 (增长 11.8%) |
| **API 扩展** | 40+ 个方法 | 增加 targetRoomID 可选参数 |

---

## ✅ 总结

本次多房间支持改动通过精心设计的架构，在保持完全向后兼容的前提下，为 ZEGO UIKit 增加了强大的多房间能力。核心创新点包括:

1. **RoomMap 容器**: 统一的多房间数据管理
2. **预备房间机制**: 优雅解决监听器生命周期
3. **渐进式 API**: 可选的 targetRoomID 参数
4. **模式切换**: 灵活的单/多房间运行模式

该方案已在生产环境验证，具备良好的扩展性和稳定性。

